<!DOCTYPE html>
<html layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8" />
    <title>상품 등록</title>
    <link rel="stylesheet" th:href="@{/css/page/register.css}" />
</head>
<body>
<div layout:fragment="content" class="wrapper">
    <div class="container main">
        <h2>상품 등록</h2>
        
        <form th:action="@{/items/new}" th:object="${itemFormDto}" method="post" enctype="multipart/form-data" autocomplete="off">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <table>
                <tr>
                    <td><label for="name">상품명</label></td>
                    <td>
	                    <input type="text" id="name" th:field="*{name}" placeholder="상품명을 입력해주세요." />
	                    <div class="text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                    </td>
                </tr>
                <tr>
                    <td><label for="description">상세설명</label></td>
                    <td>
                        <textarea id="description" th:field="*{description}" placeholder="전화번호, sns 계정 등 개인정보 입력은 제항될 수 있습니다.
상품 상태, 수량, 구매시기, 하자 유무 자세히 작성해주세요."></textarea>
						<div class="text-danger" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                    </td>
                </tr>
                <tr>
                    <td><label for="images">상품이미지</label></td>
                    <td>
                        <input type="file" id="images" th:field="*{images}" multiple />
                        <p style="font-size: 12px; color: #888;">1장 이상 업로드</p>
                        <div class="text-danger" th:if="${#fields.hasErrors('images')}" th:errors="*{images}"></div>
                    </td>
                </tr>
                <tr>
                    <td><label for="price">가격</label></td>
                    <td>
                        <input type="text" id="price" th:field="*{price}" inputmode="numeric" pattern="[0-9,]*" /> 원
                        <div class="text-danger" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
                    </td>
                </tr>
                <tr>
                    <td><label for="region">지역</label></td>
                    <td><input type="text" id="region" th:field="*{region}" placeholder="예시) 인천 부평구 부평동"/></td>
                </tr>
                <tr>
                    <td><label for="parentCategoryId">카테고리(팀)</label></td>
                    <td class="category-select">
                                        <select id="parentCategoryId" th:field="*{parentCategoryId}" required>
                    <option value="">팀을 선택하세요</option>
                    <option th:each="parent : ${parents}"
                            th:value="${parent.id}"
                            th:text="${parent.name}"
                            th:selected="${parent.id == itemFormDto.parentCategoryId}">
                    </option>
                </select>
                        <div class="text-danger" th:if="${#fields.hasErrors('parentCategoryId')}" th:errors="*{parentCategoryId}"></div>
                    </td>
                </tr>
                <tr>
                    <td><label for="childCategoryId">카테고리(품목)</label></td>
                    <td class="category-select">
                        <select id="childCategoryId" th:field="*{childCategoryId}" required>
                            <option value="">품목을 선택하세요</option>
                            <option th:each="child : ${children}"
                                    th:value="${child.id}"
                                    th:text="${child.name}"
                                    th:selected="${child.id == itemFormDto.childCategoryId}">
                            </option>
                        </select>
                        <div class="text-danger" th:if="${#fields.hasErrors('childCategoryId')}" th:errors="*{childCategoryId}"></div>
                    </td>
                </tr>
            </table>
            <div class="submit-btn">
                <button type="submit">등록하기</button>
            </div>
        </form>
    </div>
</div>
<script layout:fragment="script" th:src="@{/js/item.js}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const parentSelect = document.getElementById('parentCategoryId');
    const childSelect = document.getElementById('childCategoryId');
    
    // 부모 카테고리 변경 시 자식 카테고리 업데이트
    parentSelect.addEventListener('change', function() {
        const parentId = this.value;
        const childId = childSelect.value;
        
        // 자식 카테고리 초기화
        childSelect.innerHTML = '<option value="">품목을 선택하세요</option>';
        
        if (parentId) {
            // AJAX로 자식 카테고리 가져오기
            fetch(`/items/categories/children?parentId=${parentId}`)
                .then(response => response.json())
                .then(children => {
                    children.forEach(child => {
                        const option = document.createElement('option');
                        option.value = child.id;
                        option.textContent = child.name;
                        childSelect.appendChild(option);
                    });
                    
                    // 이전에 선택된 자식 카테고리가 있다면 선택
                    if (childId && children.some(c => c.id == childId)) {
                        childSelect.value = childId;
                    }
                })
                .catch(error => {
                    console.error('자식 카테고리 로드 실패:', error);
                });
        }
    });
    
    // 페이지 로드 시 부모 카테고리가 선택되어 있다면 자식 카테고리도 로드
    if (parentSelect.value) {
        parentSelect.dispatchEvent(new Event('change'));
    }
});
</script>
</body>
</html>
