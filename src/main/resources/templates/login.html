<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>로그인</title>
<link rel="stylesheet" type="text/css" th:href="@{/css/page/login.css}">
</head>
<body>
	<div class="login-container">
		<h1 class="logo">tradeZone</h1>
		<p class="slogan">EVERY GREAT DEAL STARTS WITH A TRADE</p>

		<div th:if="${message}" class="alert alert-success">
			<p th:text="${message}"></p>
		</div>

		<form class="login-form" th:action="@{/member/login}" method="post">
			<div th:if="${param.error}">
				<div class="error-text">이메일 또는 비밀번호를 확인해 주세요.</div>
			</div>

			<label for="email">이메일</label>
			<input type="text" id="email" name="email" placeholder="tradeZone@example.com" />
			
			<label for="password">비밀번호</label>
			<input type="password" id="password" name="password" />

			<button type="submit" id="login_button" class="login-button" disabled>로그인</button>

			<div class="container"
				style="display: flex; justify-content: center; align-content: center; align-items: center; flex-direction: column; margin: 0 auto;">
				<a th:href="${location}"><img
					src="/images/kakao_login_medium_wide.png">
				</a>
			</div>
			<div class="links">
				<a th:href="@{/member/join}">회원가입</a>
				<a href="/member/updateidentity">비밀번호 찾기</a>
			</div>
		</form>
	</div>


	<!-- 본인 확인 -->
	<div class="reset">
		<form id="step1" class="login-form d-none">
		<h5 class="mb-3">본인 확인을 위해 작성해 주세요</h5>
			<div class="mb-3">
				<label for="memberEmail">이메일</label>
				<input type="email" id="memberEmail" class="form-control" required>
			</div>
			<div class="mb-3">
				<label for="memberPhone">연락처</label>
				<input type="text" id="memberPhone" class="form-control" maxlength="13"
					placeholder="010-1234-5678" required>
			</div>
			<button type="submit" class="login-button">다음</button>
		</form>

		<!-- 인증번호 입력 -->
		<form id="step2" class="login-form">
			<h5 class="mb-3">인증번호 입력를 입력해 주세요</h5>
			<div class="mb-3">
				<label for="verificationCode">인증번호</label> <input
					type="text" id="verificationCode" class="form-control"
					maxlength="6" required>
			</div>
			<button type="submit" class="login-button">다음</button>
		</form>

		<!-- 새 비밀번호 설정 -->
		<form id="step3" class="login-form">
			<h5 class="mb-3">새 비밀번호를 입력해 주세요</h5>
			<div class="mb-3">
				<label for="newPassword">새 비밀번호</label> <input
					type="password" id="newPassword" class="form-control" required>
			</div>
			<div class="mb-3">
				<label for="confirmPassword">비밀번호 확인</label> <input
					type="password" id="confirmPassword" class="form-control" required>
			</div>
			<button type="submit" class="login-button">변경</button>
		</form>
	</div>
	
	<!-- 자바스크립트 -->
	<script layout:fragment="script" type="text/javascript">
	
	const inputEmail = document.getElementById('email');
	const inputPw = document.getElementById('password');
	const loginBtn = document.getElementById('login_button');
	
	const isActiveLogin = () => {
		let email = inputEmail.value.trim();
		let pw = inputPw.value.trim();
		
		loginBtn.disabled = !(email && pw);
	}

	const init = () => {
		inputEmail.addEventListener('input', isActiveLogin)
		inputPw.addEventListener('input', isActiveLogin)
	}
	
	init();
	
	//
	const memberPhoneInput = document.getElementById('memberPhone');

    // 연락처 가운데 하이픈 삽입
    memberPhoneInput.addEventListener('input', function () {
        let digits = this.value.replace(/\D/g, '').slice(0, 11);
        if (digits.length >= 11) {
            this.value = digits.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
        } else if (digits.length >= 7) {
            this.value = digits.replace(/(\d{3})(\d{4})/, '$1-$2');
        } else if (digits.length >= 4) {
            this.value = digits.replace(/(\d{3})(\d{1,3})/, '$1-$2');
        } else {
            this.value = digits;
        }
    });

    // 본인 확인
    document.getElementById('step1').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('memberEmail').value.trim();
        const phone = memberPhoneInput.value.trim();
		console.log(phone);
		console.log(email);
		
        if (!email || !phone) {
            alert('모든 정보를 입력해주세요.');
            return;
        }

        if (!/^\d{3}-\d{4}-\d{4}$/.test(phone)) {
            alert('연락처가 잘못되었습니다.');
            return;
        }

        // 정보 확인
        fetch('/member/updateidentity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email,
                phone
            })
        })
            .then(res => res.json())
            .then(data => {
            	console.log(data);
                if (data.success) {
                	alert('인증번호가 발송되었습니다.');
                    this.classList.add('d-none');
                    document.getElementById('step2').classList.remove('d-none');
                } else {
                    alert(data.message || '본인 확인에 실패했습니다.');
                }
            })
            .catch(err => {
                console.error('본인 확인 오류:', err);
                alert('서버 오류가 발생했습니다.');
            });
    });

    // 코드 확인
    document.getElementById('step2').addEventListener('submit', function(e) {
        e.preventDefault();
        const verificationCode = document.getElementById('verificationCode').value.trim();
        if (!/^\d{6}$/.test(verificationCode)) {
            alert('인증번호는 숫자 6자리여야 합니다.');
            return;
        }
        this.classList.add('d-none');
        document.getElementById('step3').classList.remove('d-none');
    });

    // 비밀번호 재설정
    document.getElementById('step3').addEventListener('submit', function(e) {
        e.preventDefault();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
        }

        // 변경된 비밀번호 전송
        fetch('/member/resetpassword', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                newPassword,
                confirmPassword
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('비밀번호가 성공적으로 변경되었습니다.');
                    window.location.href = '/member/login';
                } else {
                    alert(data.message || '비밀번호 변경에 실패했습니다.');
                }
            })
            .catch(err => {
                console.error('비밀번호 변경 오류:', err);
                alert('서버 오류가 발생했습니다.');
            });
    });
	
	// 비밀번호 찾기 단계별 폼 전환
	document.addEventListener('DOMContentLoaded', () => {
		  const loginContainer = document.querySelector('.login-container');
		  const resetOverlay = document.querySelector('.reset');
		  const findPasswordLink = document.querySelector('a[href="/member/updateidentity"]');

		  const steps = [
		    document.getElementById('step1'),
		    document.getElementById('step2'),
		    document.getElementById('step3')
		  ];

		  let currentStep = 0;

		  // 단계 전환 함수
		  function showStep(index) {
		    steps.forEach((step, i) => {
		      if (i === index) {
		        step.style.display = 'block';
		        step.style.opacity = 0;
		        setTimeout(() => {
		          step.style.opacity = 1;
		        }, 10); // transition 트리거
		      } else {
		        step.style.opacity = 0;
		        setTimeout(() => {
		          step.style.display = 'none';
		        }, 300); // transition 시간 이후에 display:none 처리
		      }
		    });
		    currentStep = index;
		  }

		  // 비밀번호 찾기 링크 클릭 시
		  findPasswordLink.addEventListener('click', (e) => {
		    e.preventDefault();
		    loginContainer.style.display = 'none';
		    resetOverlay.style.display = 'block';
		    setTimeout(() => {
		      resetOverlay.style.opacity = 1;
		    }, 10); // 페이드 인 트리거
		    showStep(0);
		  });

		  // 외부 클릭 시 reset 닫고 로그인으로
		  resetOverlay.addEventListener('click', (e) => {
		  // 실제로 클릭한 요소가 step1~3 내부 폼이면 무시
		  if (
		    e.target.closest('#step1') ||
		    e.target.closest('#step2') ||
		    e.target.closest('#step3')
		  ) {
		    return;
		  }

		  // 바깥을 누른 경우
		  resetOverlay.style.opacity = 0;
		  setTimeout(() => {
		    resetOverlay.style.display = 'none';
		    loginContainer.style.display = 'block';
		  	}, 300);
		  });

		  // step1 → step2
		  steps[0].addEventListener('submit', (e) => {
		    e.preventDefault();
		    showStep(1);
		  });

		  // step2 → step3
		  steps[1].addEventListener('submit', (e) => {
		    e.preventDefault();
		    showStep(2);
		  });

		  // step3 → 완료
		  steps[2].addEventListener('submit', (e) => {
		    e.preventDefault();
		    alert('비밀번호가 변경되었습니다.');
		    resetOverlay.style.opacity = 0;
		    setTimeout(() => {
		      resetOverlay.style.display = 'none';
		      loginContainer.style.display = 'block';
		    }, 300);
		  });
		});
	</script>
</body>
</html>